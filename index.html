<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–í–∏–¥–∂–µ—Ç –ê–Ω–Ω–∞</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif; background: transparent; color: #333;
    }
    .widget-container {
      position: fixed; bottom: 20px; right: 20px; width: 360px; height: 580px;
      background: rgba(255, 255, 255, 0.85); border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3); display: flex; flex-direction: column;
      overflow: hidden; z-index: 9999; backdrop-filter: blur(12px);
    }
    @media (max-width: 768px) {
      .widget-container { position: fixed !important; inset: 0 !important; width: 100vw !important; height: 100dvh !important; max-height: 100dvh !important; border-radius: 0 !important; }
    }
    .tabs { display: flex; justify-content: center; background: linear-gradient(to right, #72c9ff, #0094ff); border-bottom: 1px solid #ccc; }
    .tab { padding: 12px 16px; cursor: pointer; color: #fff; font-size: 14px; transition: background 0.2s; }
    .tab.active { background: rgba(255,255,255,0.15); border-bottom: 2px solid #fff; color: #fff; }

    .chat-window { flex: 1; display: none; flex-direction: column; height: 100%; overflow: hidden; }
    .chat-window.active { display: flex; }
    .chat-box { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; justify-content: flex-end; }
    .message { margin-bottom: 8px; padding: 10px 14px; border-radius: 14px; max-width: 85%; font-size: 14px; word-break: break-word; backdrop-filter: blur(4px); display: flex; flex-direction: column; gap: 6px; overflow: visible; }
    .from-user { background: rgba(0, 148, 255, 0.2); align-self: flex-end; color: #003366; }
    .from-bot { background: rgba(0, 0, 0, 0.05); align-self: flex-start; color: #222; }
    .chat-controls { display: flex; gap: 6px; padding: 10px; background: rgba(255,255,255,0.6); box-sizing: border-box; border-top: 1px solid #ddd; backdrop-filter: blur(8px); }
    .chat-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 12px; font-size: 14px; outline: none; }
    button { padding: 10px; border: none; border-radius: 12px; background-color: #0094ff; color: #fff; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
    button:hover { background-color: #007cd6; }
    button svg { width: 18px; height: 18px; fill: white; }
    .bot-label { font-weight: bold; color: #0074bc; }
    #voice-status { padding: 15px; font-size: 14px; color: #444; text-align: center; background: rgba(255,255,255,0.5); backdrop-filter: blur(6px); }
    .mic-button { width: 80px; height: 80px; border-radius: 50%; background-color: #0094ff; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; margin: 20px auto; transition: background 0.3s; }
    .mic-button:hover { background-color: #007cd6; }
    .mic-button svg { width: 30px; height: 30px; fill: white; }
    .chat-window, .chat-box { min-height: 0 !important; overflow-y: auto !important; }
    .widget-container { overflow: auto !important; }

    /* –±—ã—Å—Ç—Ä—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ */
    .suggest-row { display:flex; gap:8px; padding:8px 10px 10px; background: rgba(255,255,255,0.75); border-bottom:1px solid #e8e8e8; flex-wrap:wrap; }
    .suggest-btn {
      font-size:12px; line-height:1; padding:8px 10px; border-radius:999px;
      background:#eef6ff; color:#0d5ea6; border:1px solid #cfe6ff; cursor:pointer;
    }
    .suggest-btn:hover { background:#e1f0ff; }
  </style>
</head>
<body>
  <div class="widget-container">
    <div class="tabs">
      <div class="tab active" onclick="switchMode('text')">–ü–µ—Ä–µ–ø–∏—Å–∫–∞</div>
      <div class="tab" onclick="switchMode('voice')">–†–∞–∑–≥–æ–≤–æ—Ä</div>
    </div>

    <!-- –í–ï–†–•–ù–ò–ô –ë–õ–û–ö "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —é—Ä–∏—Å—Ç—ã" -->
    <section style="position:relative;width:100%;min-height:180px;background:#fff center/cover no-repeat url('https://i.imgur.com/k2Dpj2P.png');border-bottom:1px solid #e8e8e8;">
      <div style="position:absolute;inset:0;padding:16px;display:flex;flex-direction:column;justify-content:center;gap:10px;background:rgba(255,255,255,0.55);backdrop-filter:blur(3px);">
        <div style="font-weight:700;font-size:16px;color:#1e2a33;line-height:1.3;">–ü–æ—á–µ–º—É –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —é—Ä–∏—Å—Ç—ã –ø–æ–º–æ–≥–∞—é—Ç –Ω–µ —Ö—É–∂–µ, –∞ –∏–Ω–æ–≥–¥–∞ –∏ –ª—É—á—à–µ</div>
        <ul style="margin:0;padding-left:18px;color:#31424d;font-size:13px;line-height:1.35;">
          <li><b>–û–ø—ã—Ç –∏ –ø—Ä–∞–∫—Ç–∏–∫–∞.</b> –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π ‚Äî –Ω–µ –∑–Ω–∞—á–∏—Ç ¬´–±–µ–∑ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏¬ª.</li>
          <li><b>24/7.</b> –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫.</li>
          <li><b>–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã.</b> –ë–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã –∏ ¬´–∑–∞—Ç—è–≥–∏–≤–∞–Ω–∏—è¬ª.</li>
        </ul>
      </div>
    </section>

    <!-- –¢–ï–ö–°–¢–û–í–´–ô –ß–ê–¢ -->
    <div class="chat-window active" id="text-chat">
      <!-- —à–∞–ø–∫–∞ -->
      <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(255,255,255,0.8);border-bottom:1px solid #e8e8e8;backdrop-filter:blur(6px);">
        <img src="https://i.imgur.com/VnE8ZUa.png" alt="–ê–Ω–Ω–∞" style="width:36px;height:36px;border-radius:50%;object-fit:cover;flex:0 0 36px;">
        <div style="font-weight:700;color:#0d5ea6;font-size:14px;">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –Ω–∞ —Å–≤—è–∑–∏. –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ê–Ω–Ω–∞.</div>
      </div>
      <!-- –±—ã—Å—Ç—Ä—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ -->
      <div class="suggest-row">
        <button class="suggest-btn" onclick="quickAsk('–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç–µ –º–Ω–µ')">–ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç–µ –º–Ω–µ</button>
        <button class="suggest-btn" onclick="quickAsk('–ì–¥–µ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å?')">–≥–¥–µ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å</button>
        <button class="suggest-btn" onclick="quickAsk('–í–æ–ø—Ä–æ—Å –ø–æ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤—É')">–≤–æ–ø—Ä–æ—Å –ø–æ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤—É</button>
      </div>
      <div class="chat-box"><div id="chat"></div></div>
      <div class="chat-controls">
        <input class="chat-input" id="chatInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
        <button onclick="sendMessage()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M476 3.8c-3.6-1.5-7.6-1.5-11.2 0L36.3 189.7c-5.9 2.4-9.8 8.1-9.8 14.3s3.9 11.9 9.8 14.3l138.3 57.6 57.6 138.3c2.4 5.9 8.1 9.8 14.3 9.8 6.2 0 11.9-3.9 14.3-9.8L508.2 47.2c3.7-8.7-.2-18.6-9.6-23.4z"/></svg>
        </button>
        <button onclick="startTextVoice()" title="–ì–æ–ª–æ—Å–æ–º">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M192 256c0 17.7-14.3 32-32 32s-32-14.3-32-32V128c0-17.7 14.3-32 32-32s32-14.3 32 32V256zM160 320c35.3 0 64-28.7 64-64V128a64 64 0 1 0-128 0V256c0 35.3 28.7 64 64 64zm56 32H104c-13.3 0-24 10.7-24 24s10.7 24 24 24h24v56c0 13.3 10.7 24 24 24s24-10.7 24-24V400h24c13.3 0 24-10.7 24-24s-10.7-24-24-24z"/></svg>
        </button>
      </div>
    </div>

    <!-- –ì–û–õ–û–°–û–í–û–ô –ß–ê–¢ -->
    <div class="chat-window" id="voice-chat">
      <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(255,255,255,0.8);border-bottom:1px solid #e8e8e8;backdrop-filter:blur(6px);">
        <img src="https://i.imgur.com/VnE8ZUa.png" alt="–ê–Ω–Ω–∞" style="width:36px;height:36px;border-radius:50%;object-fit:cover;flex:0 0 36px;">
        <div style="font-weight:700;color:#0d5ea6;font-size:14px;">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –Ω–∞ —Å–≤—è–∑–∏. –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ê–Ω–Ω–∞.</div>
      </div>
      <div id="voice-status">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div>
      <div style="text-align:center;">
        <button class="mic-button" title="–ì–æ–≤–æ—Ä–∏—Ç—å">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M192 256c0 17.7-14.3 32-32 32s-32-14.3-32-32V128c0-17.7 14.3-32 32-32s32 14.3 32 32V256zM160 320c35.3 0 64-28.7 64-64V128a64 64 0 1 0-128 0V256c0 35.3 28.7 64 64 64zm56 32H104c-13.3 0-24 10.7-24 24s10.7 24 24 24h24v56c0 13.3 10.7 24 24 24s24-10.7 24-24V400h24c13.3 0 24-10.7 24-24s-10.7-24-24-24z"/></svg>
        </button>
      </div>
    </div>
  </div>

 <script>
const OPENAI_PROXY_URL = "https://openai-gpt-proxy-mcnj.onrender.com/gpt";
const ELEVENLABS_STREAM_URL = "https://elevenlabs-proxy-1o1s.onrender.com/stream";

let messages = [];
const userId = localStorage.getItem("userId") || "user_" + Math.random().toString(36).substr(2, 9);
localStorage.setItem("userId", userId);

const chatBox = document.querySelector(".chat-box");
const chatInput = document.getElementById("chatInput");
const micButton = document.querySelector(".mic-button");

const urlParams = new URLSearchParams(window.location.search);
let widgetMode = urlParams.get("mode") || "text";

document.addEventListener("DOMContentLoaded", () => {
  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
});

// –±—ã—Å—Ç—Ä—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
function quickAsk(text){
  chatInput.value = text;
  sendMessage();
}

function switchMode(mode) {
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.chat-window').forEach(win => win.classList.remove('active'));
  if (mode === 'text') {
    document.querySelector('.tab:nth-child(1)').classList.add('active');
    document.getElementById('text-chat').classList.add('active');
  } else {
    document.querySelector('.tab:nth-child(2)').classList.add('active');
    document.getElementById('voice-chat').classList.add('active');
  }
}

// üî• —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∞
async function handleFormTags(fullText) {
  if (/\[openLeadForm\]/i.test(fullText)) {
    parent.postMessage({ type: "open-form" }, "*");
  }
}

function sendMessage() {
  const text = chatInput.value.trim();
  if (!text) return;

  appendMessage(text, true);
  messages.push({ role: "user", content: text });
  chatInput.value = "";

  fetch(OPENAI_PROXY_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ messages, userId, mode: widgetMode })
  })
    .then(res => res.json())
    .then(async data => {
      const gptMessage = data.choices?.[0]?.message?.content || "";

      // üî• –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–æ —Ç–µ–∫—Å—Ç—É, –∏ –ø–æ —Ñ–ª–∞–≥—É triggerForm
      if (data?.triggerForm || /\[openLeadForm\]/i.test(gptMessage)) {
        parent.postMessage({ type: "open-form" }, "*");
      }

      appendMessage(gptMessage, false);
      const cleanForHistory = gptMessage.replace(/\[openLeadForm\]/gi, "").trim();
      messages.push({ role: "assistant", content: cleanForHistory });
    })
    .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞:", error));
}

function appendMessage(text, isUser) {
  const msg = document.createElement("div");
  msg.className = "message " + (isUser ? "from-user" : "from-bot");
  let display = text;

  if (!isUser && /\[openLeadForm\]/i.test(display)) {
    parent.postMessage({ type: "open-form" }, "*");
    display = display.replace(/\[openLeadForm\]/gi, "").trim();
  }

  msg.innerHTML = isUser
    ? `<span class='user-label'>–í—ã:</span> ${display}`
    : `<span class='bot-label'>–ê–Ω–Ω–∞:</span> ${display}`;

  document.getElementById("chat").appendChild(msg);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function startTextVoice() {
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = "ru-RU";
  recognition.start();
  recognition.onresult = (event) => {
    const text = event.results[0][0].transcript;
    chatInput.value = text;
    sendMessage();
  };
  recognition.onerror = () => alert("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è");
}

let isListening = false;
let recognition;

micButton.addEventListener("click", () => {
  const status = document.getElementById("voice-status");

  if (!isListening) {
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = "ru-RU";
    recognition.continuous = true;
    recognition.interimResults = false;

    recognition.onstart = () => {
      status.innerText = "üé§ –°–ª—É—à–∞—é...";
      isListening = true;
    };

    recognition.onresult = async (event) => {
      const text = event.results[event.results.length - 1][0].transcript;
      status.innerText = "üó£ " + text;
      messages.push({ role: "user", content: text });

      try {
        const res = await fetch(OPENAI_PROXY_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages, userId, mode: widgetMode === "text" ? "voice" : widgetMode })
        });

        const data = await res.json();
        const reply = data?.choices?.[0]?.message?.content || "–û—à–∏–±–∫–∞";

        // üî• –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ñ–æ—Ä–º—É
        if (reply.includes("[openLeadForm]") || data?.triggerForm) {
          parent.postMessage({ type: "open-form" }, "*");
        }

        const voiceText = reply.replace(/\[openLeadForm\]/gi, "").trim();
        messages.push({ role: "assistant", content: voiceText });
        speakText(voiceText);
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ GPT:", err);
      }
    };

    recognition.onend = () => {};
    recognition.start();
  } else {
    recognition.stop();
    status.innerText = "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å";
    isListening = false;
  }
});

async function speakText(text) {
  try {
    if (recognition && isListening) recognition.stop();
    if (window.__ttsAudio) try { window.__ttsAudio.pause(); } catch {}
    if (window.__ttsURL) try { URL.revokeObjectURL(window.__ttsURL); } catch {}

    const r = await fetch(ELEVENLABS_STREAM_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text })
    });
    if (!r.ok || !r.body) return;

    const reader = r.body.getReader();
    const chunks = [];
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      if (value && value.byteLength) chunks.push(value);
    }

    const blob = new Blob(chunks, { type: "audio/mpeg" });
    const url = URL.createObjectURL(blob);
    const a = new Audio(url);
    a.playsInline = true;

    window.__ttsAudio = a;
    window.__ttsURL = url;

    a.onended = () => {
      try { URL.revokeObjectURL(url); } catch {}
      if (isListening && recognition) recognition.start();
    };

    await a.play().catch(()=>{});
  } catch (e) {
    console.error("speakText error:", e?.message || e);
  }
}

window.addEventListener("load", () => {
  setTimeout(() => {
    if (messages.length === 0) {
      parent.postMessage("open-widget", "*");
      const welcomeMessage = "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –Ω–∞ —Å–≤—è–∑–∏. –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ê–Ω–Ω–∞.";
      appendMessage(welcomeMessage, false);
      messages.push({ role: "assistant", content: welcomeMessage });
      parent.postMessage("show-notify", "*");
    }
  }, 10000);
});
</script>

  <!-- –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–æ—Ä–º—ã -->
  <a id="triggerForm" href="#popup:subscription" style="display: none;">–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É</a>
</body>
</html>
